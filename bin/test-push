#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'

require 'rest'
require 'json'
require 'cocoapods-core'

require 'safe_yaml'
SafeYAML::OPTIONS[:default_mode] = :safe

unless ARGV.size == 2
  $stderr.puts "Usage: #{File.basename(__FILE__)} host:port /path/to/file.podspec"
  exit 1
end

spec = Pod::Specification.from_file(ARGV[1])
response = REST.post("http://#{ARGV[0]}/api/v1/pods", spec.to_yaml, 'Content-Type' => 'text/yaml')

status_url = response.headers['location'].first
puts "Registered resource URL: #{status_url}"

loop do
  response = REST.get(status_url, 'Content-Type' => 'text/yaml', 'Accept' => 'text/yaml')
  puts "[#{response.status_code}] #{response.body}"
  break if [200, 404].include?(response.status_code)
  sleep 2
end
